<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas de Escenarios - CÃ¡lculo de Total</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .test-button { background: #007cba; color: white; padding: 10px 15px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #005a87; }
        .results { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Pruebas de Escenarios - CÃ¡lculo de Total de Venta</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ Instrucciones de Prueba</h2>
        <p>Esta pÃ¡gina te ayudarÃ¡ a probar todos los escenarios problemÃ¡ticos reportados:</p>
        <ol>
            <li><strong>Carga Inicial:</strong> Abrir la pÃ¡gina de ediciÃ³n y verificar que el total sea correcto</li>
            <li><strong>Recarga de Select:</strong> Simular la recarga del select de artÃ­culos</li>
            <li><strong>Agregar Nuevos Items:</strong> Simular agregar nuevos artÃ­culos</li>
            <li><strong>Eliminar Items:</strong> Simular la eliminaciÃ³n de artÃ­culos existentes</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>ğŸš€ Acciones de Prueba</h2>
        <button class="test-button" onclick="abrirPaginaEdicion()">1. Abrir PÃ¡gina de EdiciÃ³n (Venta 13)</button>
        <button class="test-button" onclick="ejecutarTodasLasPruebas()">2. Ejecutar Todas las Pruebas</button>
        <button class="test-button" onclick="limpiarConsola()">ğŸ§¹ Limpiar Consola</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Script de Pruebas Automatizadas</h2>
        <p>Copia y pega este script en la consola del navegador en la pÃ¡gina de ediciÃ³n:</p>
        <textarea readonly style="width: 100%; height: 400px;" id="testScript">
// ğŸ§ª SCRIPT DE PRUEBAS AUTOMATIZADAS PARA CÃLCULO DE TOTALES
// Copia y pega este script en la consola del navegador en la pÃ¡gina de ediciÃ³n

console.clear();
console.log("ğŸ§ª ===============================================");
console.log("ğŸ§ª INICIANDO PRUEBAS AUTOMATIZADAS DE TOTALES");
console.log("ğŸ§ª ===============================================");

// FunciÃ³n auxiliar para esperar
function esperar(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// FunciÃ³n para obtener el total actual
function obtenerTotalActual() {
    const $totalElement = $('#total-venta');
    if ($totalElement.length === 0) {
        console.error("âŒ Elemento #total-venta no encontrado");
        return null;
    }
    const texto = $totalElement.text();
    const match = texto.match(/[\d,]+\.?\d*/);
    return match ? parseFloat(match[0].replace(/,/g, '')) : 0;
}

// FunciÃ³n para contar elementos de subtotal visibles
function contarSubtotales() {
    const elementos = $('input[name*="sub_total"], input.subtotal-input, input[name*="[sub_total]"]');
    let conteo = {
        total: elementos.length,
        visibles: 0,
        conValor: 0,
        suma: 0
    };
    
    elementos.each(function() {
        const $input = $(this);
        const esVisible = $input.is(':visible') && !$input.closest('tr').hasClass('d-none');
        if (esVisible) {
            conteo.visibles++;
            const valor = parseFloat($input.val()) || 0;
            if (valor > 0) {
                conteo.conValor++;
                conteo.suma += valor;
            }
        }
    });
    
    return conteo;
}

// PRUEBA 1: Estado inicial
async function prueba1_EstadoInicial() {
    console.log("\nğŸ§ª PRUEBA 1: VERIFICACIÃ“N DEL ESTADO INICIAL");
    console.log("===========================================");
    
    const totalInicial = obtenerTotalActual();
    const subtotales = contarSubtotales();
    
    console.log(`ğŸ“Š Total mostrado: ${totalInicial}`);
    console.log(`ğŸ“Š Subtotales encontrados: ${subtotales.total}`);
    console.log(`ğŸ“Š Subtotales visibles: ${subtotales.visibles}`);
    console.log(`ğŸ“Š Subtotales con valor: ${subtotales.conValor}`);
    console.log(`ğŸ“Š Suma manual: ${subtotales.suma}`);
    
    const diferencia = Math.abs(totalInicial - subtotales.suma);
    if (diferencia < 0.01) {
        console.log("âœ… PRUEBA 1 EXITOSA: El total coincide con la suma de subtotales");
        return true;
    } else {
        console.log(`âŒ PRUEBA 1 FALLIDA: Diferencia de ${diferencia}`);
        return false;
    }
}

// PRUEBA 2: Llamada manual a actualizarTotalVenta
async function prueba2_ActualizacionManual() {
    console.log("\nğŸ§ª PRUEBA 2: LLAMADA MANUAL A actualizarTotalVenta()");
    console.log("================================================");
    
    const totalAntes = obtenerTotalActual();
    console.log(`ğŸ“Š Total antes: ${totalAntes}`);
    
    if (typeof window.actualizarTotalVenta === 'function') {
        window.actualizarTotalVenta();
        await esperar(100); // Dar tiempo para que se actualice
        
        const totalDespues = obtenerTotalActual();
        console.log(`ğŸ“Š Total despuÃ©s: ${totalDespues}`);
        
        if (Math.abs(totalAntes - totalDespues) < 0.01) {
            console.log("âœ… PRUEBA 2 EXITOSA: La funciÃ³n mantiene el total correcto");
            return true;
        } else {
            console.log(`âš ï¸ PRUEBA 2: El total cambiÃ³ de ${totalAntes} a ${totalDespues}`);
            // Verificar si el nuevo total es correcto
            const subtotales = contarSubtotales();
            if (Math.abs(totalDespues - subtotales.suma) < 0.01) {
                console.log("âœ… PRUEBA 2 EXITOSA: El nuevo total es correcto");
                return true;
            } else {
                console.log("âŒ PRUEBA 2 FALLIDA: El nuevo total no coincide con los subtotales");
                return false;
            }
        }
    } else {
        console.log("âŒ PRUEBA 2 FALLIDA: FunciÃ³n actualizarTotalVenta no encontrada");
        return false;
    }
}

// PRUEBA 3: Simular recarga del select de artÃ­culos
async function prueba3_RecargaSelect() {
    console.log("\nğŸ§ª PRUEBA 3: SIMULACIÃ“N DE RECARGA DEL SELECT");
    console.log("===========================================");
    
    const totalAntes = obtenerTotalActual();
    console.log(`ğŸ“Š Total antes de simular recarga: ${totalAntes}`);
    
    // Simular el comportamiento de reset-articulo-select.js
    if (typeof window.resetearSelectArticulos === 'function') {
        window.resetearSelectArticulos();
    } else {
        // Simular manualmente
        console.log("â„¹ï¸ Simulando recarga manual del select...");
        const $select = $('#articulo-select, select[name*="articulo"]').first();
        if ($select.length > 0) {
            $select.trigger('change');
        }
    }
    
    await esperar(500); // Dar tiempo para que se procese
    
    const totalDespues = obtenerTotalActual();
    console.log(`ğŸ“Š Total despuÃ©s de simular recarga: ${totalDespues}`);
    
    const diferencia = Math.abs(totalAntes - totalDespues);
    if (diferencia < 0.01) {
        console.log("âœ… PRUEBA 3 EXITOSA: El total se mantiene despuÃ©s de recargar select");
        return true;
    } else {
        console.log(`âŒ PRUEBA 3 FALLIDA: El total cambiÃ³ ${diferencia} despuÃ©s de recargar select`);
        return false;
    }
}

// PRUEBA 4: Verificar funciÃ³n de depuraciÃ³n
async function prueba4_FuncionDepuracion() {
    console.log("\nğŸ§ª PRUEBA 4: VERIFICACIÃ“N DE FUNCIÃ“N DE DEPURACIÃ“N");
    console.log("===============================================");
    
    if (typeof window.debugTotalCalculation === 'function') {
        console.log("âœ… FunciÃ³n de depuraciÃ³n encontrada, ejecutando...");
        window.debugTotalCalculation();
        return true;
    } else {
        console.log("âŒ PRUEBA 4 FALLIDA: FunciÃ³n debugTotalCalculation no encontrada");
        return false;
    }
}

// EJECUTAR TODAS LAS PRUEBAS
async function ejecutarTodasLasPruebas() {
    console.log("ğŸ§ª EJECUTANDO BATERÃA COMPLETA DE PRUEBAS");
    console.log("===============================================");
    
    const resultados = [];
    
    resultados.push(await prueba1_EstadoInicial());
    await esperar(1000);
    
    resultados.push(await prueba2_ActualizacionManual());
    await esperar(1000);
    
    resultados.push(await prueba3_RecargaSelect());
    await esperar(1000);
    
    resultados.push(await prueba4_FuncionDepuracion());
    
    console.log("\nğŸ§ª ===============================================");
    console.log("ğŸ§ª RESUMEN DE RESULTADOS DE PRUEBAS");
    console.log("ğŸ§ª ===============================================");
    
    const exitosas = resultados.filter(r => r).length;
    const fallidas = resultados.length - exitosas;
    
    console.log(`âœ… Pruebas exitosas: ${exitosas}`);
    console.log(`âŒ Pruebas fallidas: ${fallidas}`);
    
    if (fallidas === 0) {
        console.log("ğŸ‰ Â¡TODAS LAS PRUEBAS EXITOSAS!");
    } else {
        console.log("âš ï¸ Algunas pruebas fallaron, revisar logs arriba");
    }
    
    return fallidas === 0;
}

// Ejecutar automÃ¡ticamente
ejecutarTodasLasPruebas();
        </textarea>
        <button class="test-button" onclick="copiarScript()">ğŸ“‹ Copiar Script</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ Resultados de Pruebas</h2>
        <div id="resultados" class="results">
            <em>Los resultados aparecerÃ¡n aquÃ­ despuÃ©s de ejecutar las pruebas...</em>
        </div>
    </div>

    <script>
        function abrirPaginaEdicion() {
            window.open('http://127.0.0.1:8000/admin/venta/13/edit', '_blank');
        }

        function copiarScript() {
            const script = document.getElementById('testScript');
            script.select();
            script.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('Script copiado al portapapeles. PÃ©galo en la consola del navegador en la pÃ¡gina de ediciÃ³n.');
        }

        function limpiarConsola() {
            console.clear();
            console.log('ğŸ§¹ Consola limpiada');
        }

        function ejecutarTodasLasPruebas() {
            alert('Para ejecutar las pruebas:\n\n1. Abre la pÃ¡gina de ediciÃ³n (botÃ³n "Abrir PÃ¡gina de EdiciÃ³n")\n2. Abre las herramientas de desarrollador (F12)\n3. Ve a la pestaÃ±a "Console"\n4. Copia y pega el script de pruebas\n5. Presiona Enter');
        }
    </script>
</body>
</html>
