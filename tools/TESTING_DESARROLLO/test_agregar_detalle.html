<?php
/**
 * Script para probar la funcionalidad de agregar nuevo detalle
 * Ejecutar en el navegador despu√©s de cargar la p√°gina de edici√≥n de venta
 */
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Funcionalidad Agregar Detalle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-card { border-left: 4px solid #28a745; }
        .code-block { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 5px; 
            padding: 15px; 
            font-family: 'Courier New', monospace; 
            font-size: 14px;
            white-space: pre-wrap;
        }
        .step { margin: 20px 0; padding: 15px; border-left: 3px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Test: Funcionalidad Agregar Nuevo Detalle</h2>
        
        <div class="alert alert-info">
            <h5><i class="bi bi-info-circle"></i> Instrucciones</h5>
            <ol>
                <li>Abra la p√°gina de edici√≥n de venta en otra pesta√±a</li>
                <li>Abra las herramientas de desarrollador (F12)</li>
                <li>Vaya a la pesta√±a Console</li>
                <li>Copie y pegue cada script de abajo uno por uno</li>
                <li>Ejecute cada paso y observe los resultados</li>
            </ol>
        </div>

        <div class="step">
            <h4>Paso 1: Verificar que los elementos existen</h4>
            <div class="code-block">
// === VERIFICACI√ìN DE ELEMENTOS ===
console.log('üîç Verificando elementos del formulario...');
const elementos = {
    'Bot√≥n agregar': $('#agregar-detalle').length,
    'Select art√≠culo': $('#articulo').length,
    'Input cantidad': $('#cantidad-nuevo').length,
    'Select descuento': $('#descuento-nuevo').length,
    'Select trabajadores': $('#trabajadores-carwash-nuevo').length,
    'Tbody nuevos detalles': $('#nuevos-detalles').length,
    'Container nuevos detalles': $('#nuevos-detalles-container').length
};

Object.entries(elementos).forEach(([nombre, cantidad]) => {
    console.log(`${cantidad > 0 ? '‚úÖ' : '‚ùå'} ${nombre}: ${cantidad}`);
});
            </div>
        </div>

        <div class="step">
            <h4>Paso 2: Verificar Select2</h4>
            <div class="code-block">
// === VERIFICACI√ìN DE SELECT2 ===
console.log('üîç Verificando Select2...');
const select2Status = {
    'Art√≠culo': $('#articulo').hasClass('select2-hidden-accessible'),
    'Descuento': $('#descuento-nuevo').hasClass('select2-hidden-accessible'),
    'Trabajadores': $('#trabajadores-carwash-nuevo').hasClass('select2-hidden-accessible')
};

Object.entries(select2Status).forEach(([nombre, inicializado]) => {
    console.log(`${inicializado ? '‚úÖ' : '‚ùå'} Select2 ${nombre}: ${inicializado ? 'Inicializado' : 'NO inicializado'}`);
});

console.log('üìä Opciones disponibles:');
console.log(`  - Art√≠culos: ${$('#articulo option').length}`);
console.log(`  - Descuentos: ${$('#descuento-nuevo option').length}`);
console.log(`  - Trabajadores: ${$('#trabajadores-carwash-nuevo option').length}`);
            </div>
        </div>

        <div class="step">
            <h4>Paso 3: Verificar eventos</h4>
            <div class="code-block">
// === VERIFICACI√ìN DE EVENTOS ===
console.log('üîç Verificando eventos...');
const eventos = $._data($('#agregar-detalle')[0], 'events');
console.log('Eventos en bot√≥n agregar:', eventos);

if (eventos && eventos.click) {
    console.log('‚úÖ Evento click encontrado:', eventos.click.length, 'handler(s)');
    eventos.click.forEach((event, index) => {
        console.log(`  Handler ${index + 1}:`, event.handler.toString().substring(0, 100) + '...');
    });
} else {
    console.log('‚ùå NO se encontr√≥ evento click en el bot√≥n');
    console.log('üîß Intentando re-agregar evento...');
    
    $('#agregar-detalle').off('click').on('click', function() {
        console.log('üî• EVENTO CLICK MANUAL EJECUTADO');
        alert('¬°El bot√≥n funciona! Pero falta la l√≥gica de agregar detalle.');
    });
    
    console.log('‚úÖ Evento manual agregado');
}
            </div>
        </div>

        <div class="step">
            <h4>Paso 4: Preparar datos de prueba</h4>
            <div class="code-block">
// === PREPARAR DATOS DE PRUEBA ===
console.log('üîß Preparando datos de prueba...');

// Buscar primer art√≠culo disponible
const primerArticulo = $('#articulo option:not([value=""])').first();
if (primerArticulo.length > 0) {
    console.log('‚úÖ Art√≠culo encontrado:', primerArticulo.text());
    $('#articulo').val(primerArticulo.val()).trigger('change');
    console.log('üìù Art√≠culo seleccionado:', $('#articulo').val());
    
    // Establecer cantidad
    $('#cantidad-nuevo').val('2');
    console.log('üìù Cantidad establecida:', $('#cantidad-nuevo').val());
    
    // Buscar primer descuento si hay
    const primerDescuento = $('#descuento-nuevo option:not([value=""])').first();
    if (primerDescuento.length > 0) {
        $('#descuento-nuevo').val(primerDescuento.val()).trigger('change');
        console.log('üìù Descuento seleccionado:', $('#descuento-nuevo').val());
    }
    
    console.log('‚úÖ Datos de prueba preparados');
    console.log('üéØ Estado actual:');
    console.log(`  - Art√≠culo: ${$('#articulo').val()}`);
    console.log(`  - Cantidad: ${$('#cantidad-nuevo').val()}`);
    console.log(`  - Descuento: ${$('#descuento-nuevo').val()}`);
    
} else {
    console.log('‚ùå No hay art√≠culos disponibles');
}
            </div>
        </div>

        <div class="step">
            <h4>Paso 5: Probar el bot√≥n</h4>
            <div class="code-block">
// === PROBAR EL BOT√ìN ===
console.log('üöÄ Probando el bot√≥n agregar detalle...');
console.log('Estado del bot√≥n antes del click:', {
    'Existe': $('#agregar-detalle').length > 0,
    'Visible': $('#agregar-detalle').is(':visible'),
    'Habilitado': !$('#agregar-detalle').prop('disabled'),
    'Clase': $('#agregar-detalle').attr('class')
});

console.log('üî• Ejecutando click...');
$('#agregar-detalle').click();
console.log('‚úÖ Click ejecutado');

// Verificar resultado despu√©s de 2 segundos
setTimeout(() => {
    console.log('üìä Verificando resultado...');
    const filasNuevas = $('#nuevos-detalles tr').length;
    const containerVisible = $('#nuevos-detalles-container').is(':visible');
    
    console.log(`Filas en nuevos detalles: ${filasNuevas}`);
    console.log(`Container visible: ${containerVisible}`);
    
    if (filasNuevas > 0 && containerVisible) {
        console.log('üéâ ¬°SUCCESS! El nuevo detalle se agreg√≥ correctamente');
    } else {
        console.log('‚ùå FAIL: El nuevo detalle no se agreg√≥');
        console.log('üîç Revisando posibles errores...');
        
        // Buscar errores en la consola
        if (window.console && window.console.memory) {
            console.log('üíæ Estado de la consola: OK');
        }
    }
}, 2000);
            </div>
        </div>

        <div class="step">
            <h4>Paso 6: Diagn√≥stico avanzado (si falla)</h4>
            <div class="code-block">
// === DIAGN√ìSTICO AVANZADO ===
console.log('üîç Diagn√≥stico avanzado...');

// Verificar si hay errores JavaScript
console.log('Verificando errores JavaScript...');

// Verificar si jQuery est√° disponible
if (typeof $ === 'undefined') {
    console.log('‚ùå jQuery no est√° disponible');
} else {
    console.log('‚úÖ jQuery disponible:', $.fn.jquery);
}

// Verificar si SweetAlert est√° disponible
if (typeof Swal === 'undefined') {
    console.log('‚ùå SweetAlert no est√° disponible');
} else {
    console.log('‚úÖ SweetAlert disponible');
}

// Verificar si Select2 est√° disponible
if (typeof $.fn.select2 === 'undefined') {
    console.log('‚ùå Select2 no est√° disponible');
} else {
    console.log('‚úÖ Select2 disponible');
}

// Verificar configuraci√≥n global
if (typeof window.jirehVentaConfig === 'undefined') {
    console.log('‚ùå Configuraci√≥n global no disponible');
} else {
    console.log('‚úÖ Configuraci√≥n global disponible');
    console.log('Config keys:', Object.keys(window.jirehVentaConfig));
}

// Forzar ejecuci√≥n del evento
console.log('üîß Intentando forzar ejecuci√≥n...');
try {
    // Simular el evento manualmente
    const evento = new Event('click');
    document.getElementById('agregar-detalle').dispatchEvent(evento);
    console.log('‚úÖ Evento forzado ejecutado');
} catch (error) {
    console.log('‚ùå Error al forzar evento:', error);
}
            </div>
        </div>

        <div class="alert alert-success mt-4">
            <h5><i class="bi bi-check-circle"></i> Resultados esperados</h5>
            <ul>
                <li><strong>Todos los elementos deben existir</strong> (‚úÖ en Paso 1)</li>
                <li><strong>Select2 debe estar inicializado</strong> (‚úÖ en Paso 2)</li>
                <li><strong>Evento click debe existir</strong> (‚úÖ en Paso 3)</li>
                <li><strong>Al hacer click se debe agregar una fila</strong> (üéâ en Paso 5)</li>
                <li><strong>La tabla de nuevos detalles debe ser visible</strong></li>
            </ul>
        </div>

        <div class="alert alert-warning mt-4">
            <h5><i class="bi bi-exclamation-triangle"></i> Si algo falla</h5>
            <p>Copie TODOS los mensajes de la consola y comp√°rtalos para poder ayudar a diagnosticar el problema espec√≠fico.</p>
        </div>
    </div>
</body>
</html>
