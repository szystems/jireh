<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Trabajadores - Soluci√≥n de Persistencia</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .debug-section { 
            border: 1px solid #ddd; 
            margin: 15px 0; 
            padding: 20px; 
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
        button { 
            margin: 5px; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .problem-solution {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .solution-steps {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        ol li { margin: 8px 0; }
        .code-inline { 
            background: #e9ecef; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-family: monospace; 
        }
    </style>
</head>
<body>
    <h1>üîß Debug Trabajadores - Soluci√≥n de Persistencia</h1>
    
    <div class="debug-section">
        <h2>üéØ Problema Identificado</h2>
        <div class="problem-solution">
            <h3>‚ùå Error Principal Encontrado:</h3>
            <p>Se detect√≥ un error en el c√≥digo JavaScript donde se intenta reasignar una variable <code class="code-inline">const</code>:</p>
            <pre>
// ANTES (PROBLEM√ÅTICO):
const $containerTrabajadores = $(`#trabajadores-${detalleActualEditando}`);
// ... m√°s c√≥digo ...
$containerTrabajadores = $containerAlternativo; // ‚ùå ERROR: No se puede reasignar const

// DESPU√âS (CORREGIDO):
let $containerTrabajadores = $(`#trabajadores-${detalleActualEditando}`);
// ... m√°s c√≥digo ...
$containerTrabajadores = $containerAlternativo; // ‚úÖ CORRECTO: let permite reasignaci√≥n
            </pre>
        </div>
    </div>

    <div class="debug-section">
        <h2>‚úÖ Correcciones Implementadas</h2>
        <div class="solution-steps">
            <h3>üîß Cambios Realizados:</h3>
            <ol>
                <li><strong>Correcci√≥n de Variable:</strong> Cambi√© <code class="code-inline">const</code> a <code class="code-inline">let</code> para permitir reasignaci√≥n del container</li>
                <li><strong>Verificaci√≥n de Formulario:</strong> Agregu√© verificaci√≥n para asegurar que el container est√° dentro del formulario principal</li>
                <li><strong>Mejora en Creaci√≥n de Inputs:</strong> Cada input se verifica despu√©s de ser creado para asegurar que existe en el DOM</li>
                <li><strong>Manejo de Errores:</strong> Mejor manejo de errores con SweetAlert para informar al usuario</li>
                <li><strong>Verificaci√≥n Post-Guardado:</strong> Verificaci√≥n autom√°tica despu√©s de guardar para confirmar persistencia</li>
                <li><strong>Funciones de Debug:</strong> Agregu√© funciones globales para debugging manual</li>
            </ol>
        </div>
    </div>

    <div class="debug-section">
        <h2>üß™ Pruebas Recomendadas</h2>
        <h3>üìã Pasos para Verificar la Correcci√≥n:</h3>
        <ol>
            <li><strong>Abrir la p√°gina de edici√≥n de venta</strong> que tenga al menos un detalle de servicio</li>
            <li><strong>Abrir la consola del navegador</strong> (F12 ‚Üí Console)</li>
            <li><strong>Verificar estado inicial:</strong> Ejecutar <code class="code-inline">debugTrabajadoresManual()</code></li>
            <li><strong>Abrir modal de trabajadores</strong> para un detalle espec√≠fico</li>
            <li><strong>Modificar trabajadores:</strong> Quitar uno o agregar otro</li>
            <li><strong>Guardar cambios</strong> y verificar que no hay errores en consola</li>
            <li><strong>Verificar persistencia:</strong> Ejecutar <code class="code-inline">debugDetalleTrabajadores(ID_DETALLE)</code></li>
            <li><strong>Guardar la venta</strong> y verificar en la p√°gina show.blade.php</li>
        </ol>
    </div>

    <div class="debug-section">
        <h2>üõ†Ô∏è C√≥digo JavaScript para Testing</h2>
        <button onclick="copiarCodigo()" class="btn-success">üìã Copiar C√≥digo de Testing</button>
        <pre id="testing-code">
// === C√ìDIGO DE TESTING PARA LA CONSOLA ===

// 1. Verificar estado actual de todos los trabajadores
function testearEstadoActual() {
    console.log('üß™ === TESTING: Estado Actual ===');
    
    const inputs = document.querySelectorAll('input[name*="trabajadores_carwash"]');
    console.log('Total inputs encontrados:', inputs.length);
    
    const grupos = {};
    inputs.forEach(input => {
        const match = input.name.match(/trabajadores_carwash\[(\d+)\]/);
        if (match) {
            const detalle = match[1];
            if (!grupos[detalle]) grupos[detalle] = [];
            grupos[detalle].push(input.value);
        }
    });
    
    console.log('Trabajadores por detalle:', grupos);
    return grupos;
}

// 2. Simular edici√≥n de trabajadores
function testearEdicionTrabajadores(detalleId, nuevosTrabajadores) {
    console.log(`üß™ === TESTING: Edici√≥n Detalle ${detalleId} ===`);
    
    // Verificar container
    const container = document.getElementById(`trabajadores-${detalleId}`);
    if (!container) {
        console.error('‚ùå Container no encontrado');
        return false;
    }
    
    // Limpiar inputs existentes
    container.innerHTML = '';
    console.log('üßπ Container limpiado');
    
    // Agregar nuevos inputs
    nuevosTrabajadores.forEach(trabajadorId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `trabajadores_carwash[${detalleId}][]`;
        input.value = trabajadorId;
        container.appendChild(input);
        console.log(`‚ûï Agregado: ${input.name} = ${input.value}`);
    });
    
    // Verificar resultado
    const inputsFinales = container.querySelectorAll('input');
    console.log(`‚úÖ Resultado: ${inputsFinales.length} inputs en container`);
    
    return inputsFinales.length === nuevosTrabajadores.length;
}

// 3. Verificar que los datos se mantengan
function testearPersistencia(detalleId) {
    console.log(`üß™ === TESTING: Persistencia Detalle ${detalleId} ===`);
    
    const container = document.getElementById(`trabajadores-${detalleId}`);
    if (!container) return false;
    
    const inputs = container.querySelectorAll('input[name*="trabajadores_carwash"]');
    console.log('Inputs en container:', inputs.length);
    
    // Verificar que est√°n en el formulario
    const formulario = document.getElementById('forma-editar-venta');
    const inputsEnFormulario = formulario.querySelectorAll(`input[name*="trabajadores_carwash[${detalleId}]"]`);
    console.log('Inputs en formulario:', inputsEnFormulario.length);
    
    const coinciden = inputs.length === inputsEnFormulario.length;
    console.log('Coinciden:', coinciden);
    
    return coinciden;
}

// 4. Test completo
function testCompleto() {
    console.log('üöÄ === TEST COMPLETO DE TRABAJADORES ===');
    
    console.log('1. Estado inicial...');
    const estadoInicial = testearEstadoActual();
    
    console.log('2. Verificando containers...');
    const detalles = Object.keys(estadoInicial);
    detalles.forEach(detalleId => {
        const persistencia = testearPersistencia(detalleId);
        console.log(`   Detalle ${detalleId}: ${persistencia ? '‚úÖ' : '‚ùå'}`);
    });
    
    console.log('3. Test completado');
    return estadoInicial;
}

// Funciones globales
window.testearEstadoActual = testearEstadoActual;
window.testearEdicionTrabajadores = testearEdicionTrabajadores;
window.testearPersistencia = testearPersistencia;
window.testCompleto = testCompleto;

console.log('üß™ Funciones de testing cargadas:');
console.log('- testearEstadoActual() - Ver estado actual');
console.log('- testearEdicionTrabajadores(detalleId, [trabajadorIds]) - Simular edici√≥n');
console.log('- testearPersistencia(detalleId) - Verificar persistencia');
console.log('- testCompleto() - Test completo');
        </pre>
    </div>

    <div class="debug-section">
        <h2>üìä Qu√© Buscar en las Pruebas</h2>
        <div class="problem-solution">
            <h3>‚úÖ Indicadores de √âxito:</h3>
            <ul>
                <li>No hay errores en la consola del navegador</li>
                <li>Los inputs se crean correctamente en el container correcto</li>
                <li>El n√∫mero de inputs coincide con el n√∫mero de trabajadores seleccionados</li>
                <li>Los inputs est√°n dentro del formulario principal</li>
                <li>Los datos se mantienen despu√©s de cerrar el modal</li>
                <li>Al guardar la venta, los trabajadores se actualizan en la base de datos</li>
            </ul>
            
            <h3>‚ùå Indicadores de Problema:</h3>
            <ul>
                <li>Errores de "Cannot assign to const variable" en la consola</li>
                <li>Inputs duplicados o inputs que no se eliminan</li>
                <li>Discrepancia entre trabajadores seleccionados e inputs creados</li>
                <li>Container no encontrado o vac√≠o despu√©s de guardar</li>
                <li>Los cambios no se reflejan en show.blade.php</li>
            </ul>
        </div>
    </div>

    <div class="debug-section">
        <h2>üîÑ Si el Problema Persiste</h2>
        <div class="solution-steps">
            <h3>Pasos Adicionales:</h3>
            <ol>
                <li><strong>Limpiar cach√© del navegador</strong> (Ctrl+Shift+R)</li>
                <li><strong>Verificar el backend:</strong> Revisar logs de Laravel para errores</li>
                <li><strong>Comprobar rutas:</strong> Asegurar que la ruta de actualizaci√≥n funciona</li>
                <li><strong>Verificar validaciones:</strong> Revisar si hay validaciones que rechacen los datos</li>
                <li><strong>Debug del controlador:</strong> Agregar logs en VentaController.php</li>
            </ol>
        </div>
    </div>

    <script>
        function copiarCodigo() {
            const codigo = document.getElementById('testing-code').textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                alert('‚úÖ C√≥digo de testing copiado al portapapeles!\n\nPega este c√≥digo en la consola del navegador (F12 ‚Üí Console) en la p√°gina de edici√≥n de venta.');
            });
        }
    </script>
</body>
</html>
