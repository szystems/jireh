/**
 * Script de prueba automatizada para validar el funcionamiento completo
 * del sistema de comisiones Car Wash
 */

console.log('üß™ INICIANDO PRUEBA AUTOMATIZADA DEL SISTEMA DE COMISIONES');

// Funci√≥n para esperar un tiempo determinado
function wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Funci√≥n para simular click
function simulateClick(element) {
    if (!element) return false;
    const event = new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
    });
    element.dispatchEvent(event);
    return true;
}

// Funci√≥n para simular selecci√≥n en select m√∫ltiple
function simulateSelectMultiple(select, values) {
    if (!select) return false;
    
    // Limpiar selecciones previas
    for (let option of select.options) {
        option.selected = false;
    }
    
    // Seleccionar valores especificados
    values.forEach(value => {
        for (let option of select.options) {
            if (option.value == value) {
                option.selected = true;
                break;
            }
        }
    });
    
    // Disparar evento change
    const event = new Event('change', { bubbles: true });
    select.dispatchEvent(event);
    return true;
}

// Funci√≥n para verificar estado inicial
function verificarEstadoInicial() {
    console.log('\nüìã VERIFICANDO ESTADO INICIAL...');
    
    const checks = {
        modal: !!document.getElementById('editarTrabajadoresModal'),
        botonAgregar: !!document.querySelector('button[onclick="agregarDetalle()"]'),
        inputsTrabajadores: document.querySelectorAll('input[name*="trabajadores_carwash"]').length,
        botoneEditarExistentes: document.querySelectorAll('button[onclick*="editarTrabajadores"]').length
    };
    
    console.log('Estado inicial:', checks);
    return checks;
}

// Funci√≥n para probar edici√≥n de trabajadores existentes
async function probarEdicionTrabajadores() {
    console.log('\nüîß PROBANDO EDICI√ìN DE TRABAJADORES EXISTENTES...');
    
    // Buscar bot√≥n de editar trabajadores
    const botonEditar = document.querySelector('button[onclick*="editarTrabajadores"]');
    if (!botonEditar) {
        console.log('‚ùå No se encontr√≥ bot√≥n de editar trabajadores');
        return false;
    }
    
    console.log('‚úÖ Bot√≥n de editar encontrado, simulando click...');
    simulateClick(botonEditar);
    
    await wait(500);
    
    // Verificar que el modal se abri√≥
    const modal = document.getElementById('editarTrabajadoresModal');
    if (!modal || !modal.classList.contains('show')) {
        console.log('‚ùå Modal no se abri√≥');
        return false;
    }
    
    console.log('‚úÖ Modal abierto correctamente');
    
    // Seleccionar trabajadores en el modal
    const selectTrabajadores = modal.querySelector('select[multiple]');
    if (selectTrabajadores && selectTrabajadores.options.length > 0) {
        const valoresASeleccionar = [];
        
        // Seleccionar hasta 3 trabajadores
        for (let i = 0; i < Math.min(3, selectTrabajadores.options.length); i++) {
            if (selectTrabajadores.options[i].value) {
                valoresASeleccionar.push(selectTrabajadores.options[i].value);
            }
        }
        
        console.log(`üéØ Seleccionando trabajadores: ${valoresASeleccionar.join(', ')}`);
        simulateSelectMultiple(selectTrabajadores, valoresASeleccionar);
        
        await wait(300);
        
        // Guardar selecci√≥n
        const botonGuardar = modal.querySelector('button[onclick="guardarTrabajadores()"]');
        if (botonGuardar) {
            console.log('üíæ Guardando selecci√≥n de trabajadores...');
            simulateClick(botonGuardar);
            await wait(300);
        }
    }
    
    return true;
}

// Funci√≥n para probar agregar nuevo detalle
async function probarNuevoDetalle() {
    console.log('\n‚ûï PROBANDO AGREGAR NUEVO DETALLE...');
    
    const botonAgregar = document.querySelector('button[onclick="agregarDetalle()"]');
    if (!botonAgregar) {
        console.log('‚ùå No se encontr√≥ bot√≥n de agregar detalle');
        return false;
    }
    
    console.log('‚úÖ Bot√≥n agregar encontrado, simulando click...');
    simulateClick(botonAgregar);
    
    await wait(500);
    
    // Buscar la nueva fila agregada
    const filas = document.querySelectorAll('tr[id*="fila_detalle_"]');
    const ultimaFila = filas[filas.length - 1];
    
    if (!ultimaFila) {
        console.log('‚ùå No se encontr√≥ nueva fila agregada');
        return false;
    }
    
    console.log('‚úÖ Nueva fila agregada');
    
    // Seleccionar un art√≠culo/servicio
    const selectArticulo = ultimaFila.querySelector('select[name*="articulo_id"]');
    if (selectArticulo && selectArticulo.options.length > 1) {
        // Buscar un servicio (tipo 'servicio')
        let servicioEncontrado = false;
        for (let i = 1; i < selectArticulo.options.length; i++) {
            const option = selectArticulo.options[i];
            if (option.text.toLowerCase().includes('servicio') || option.text.toLowerCase().includes('carwash')) {
                selectArticulo.value = option.value;
                const event = new Event('change', { bubbles: true });
                selectArticulo.dispatchEvent(event);
                console.log(`üéØ Servicio seleccionado: ${option.text}`);
                servicioEncontrado = true;
                break;
            }
        }
        
        if (!servicioEncontrado) {
            // Seleccionar primer art√≠culo disponible
            selectArticulo.value = selectArticulo.options[1].value;
            const event = new Event('change', { bubbles: true });
            selectArticulo.dispatchEvent(event);
            console.log(`üéØ Art√≠culo seleccionado: ${selectArticulo.options[1].text}`);
        }
        
        await wait(500);
    }
    
    // Seleccionar trabajadores en la nueva fila
    const selectTrabajadores = ultimaFila.querySelector('select[multiple]');
    if (selectTrabajadores) {
        const valoresASeleccionar = [];
        
        // Seleccionar hasta 2 trabajadores
        for (let i = 0; i < Math.min(2, selectTrabajadores.options.length); i++) {
            if (selectTrabajadores.options[i].value) {
                valoresASeleccionar.push(selectTrabajadores.options[i].value);
            }
        }
        
        if (valoresASeleccionar.length > 0) {
            console.log(`üéØ Seleccionando trabajadores en nuevo detalle: ${valoresASeleccionar.join(', ')}`);
            simulateSelectMultiple(selectTrabajadores, valoresASeleccionar);
            await wait(300);
        }
    }
    
    return true;
}

// Funci√≥n para validar inputs finales
async function validarInputsFinales() {
    console.log('\nüîç VALIDANDO INPUTS FINALES...');
    
    // Ejecutar corrector si existe
    if (window.corregirTrabajadoresDefinitivo) {
        console.log('üîß Ejecutando corrector definitivo...');
        window.corregirTrabajadoresDefinitivo();
        await wait(200);
    }
    
    // Contar inputs de trabajadores
    const inputsTrabajadores = document.querySelectorAll('input[name*="trabajadores_carwash"]');
    console.log(`üìä Total de inputs de trabajadores: ${inputsTrabajadores.length}`);
    
    const trabajadoresData = {};
    inputsTrabajadores.forEach(input => {
        if (input.value) {
            if (!trabajadoresData[input.name]) {
                trabajadoresData[input.name] = [];
            }
            trabajadoresData[input.name].push(input.value);
        }
    });
    
    console.log('üìã Datos de trabajadores a enviar:', trabajadoresData);
    
    // Mostrar variable global si existe
    if (window.trabajadoresGlobal) {
        console.log('üåê Variable global de trabajadores:', window.trabajadoresGlobal);
    }
    
    return Object.keys(trabajadoresData).length > 0;
}

// Funci√≥n para simular env√≠o (SIN ENVIAR REALMENTE)
function simularEnvio() {
    console.log('\nüì§ SIMULANDO ENV√çO DEL FORMULARIO...');
    
    const form = document.getElementById('forma-editar-venta');
    if (!form) {
        console.log('‚ùå Formulario no encontrado');
        return false;
    }
    
    const formData = new FormData(form);
    const trabajadoresEnviados = {};
    
    for (let [key, value] of formData.entries()) {
        if (key.includes('trabajadores')) {
            if (!trabajadoresEnviados[key]) {
                trabajadoresEnviados[key] = [];
            }
            trabajadoresEnviados[key].push(value);
        }
    }
    
    console.log('üìä Datos de trabajadores que se enviar√≠an:', trabajadoresEnviados);
    
    const totalTrabajadores = Object.keys(trabajadoresEnviados).length;
    console.log(`üìà Total de campos de trabajadores a enviar: ${totalTrabajadores}`);
    
    return totalTrabajadores > 0;
}

// Funci√≥n principal de prueba
async function ejecutarPruebaCompleta() {
    console.log('üöÄ EJECUTANDO PRUEBA COMPLETA DEL SISTEMA');
    console.log('==========================================\n');
    
    const resultados = {
        estadoInicial: false,
        edicionTrabajadores: false,
        nuevoDetalle: false,
        inputsFinales: false,
        simulacionEnvio: false
    };
    
    try {
        // 1. Verificar estado inicial
        const estadoInicial = verificarEstadoInicial();
        resultados.estadoInicial = estadoInicial.modal && estadoInicial.botonAgregar;
        
        // 2. Probar edici√≥n de trabajadores existentes
        if (estadoInicial.botoneEditarExistentes > 0) {
            resultados.edicionTrabajadores = await probarEdicionTrabajadores();
        } else {
            console.log('‚ö†Ô∏è No hay detalles existentes para editar trabajadores');
            resultados.edicionTrabajadores = true; // No es un error si no hay detalles
        }
        
        // 3. Probar agregar nuevo detalle
        resultados.nuevoDetalle = await probarNuevoDetalle();
          // 4. Validar inputs finales
        await wait(500);
        resultados.inputsFinales = await validarInputsFinales();
        
        // 5. Simular env√≠o
        resultados.simulacionEnvio = simularEnvio();
        
        // Mostrar resultados finales
        console.log('\nüìä RESULTADOS DE LA PRUEBA:');
        console.log('============================');
        console.log(`Estado inicial: ${resultados.estadoInicial ? '‚úÖ' : '‚ùå'}`);
        console.log(`Edici√≥n trabajadores: ${resultados.edicionTrabajadores ? '‚úÖ' : '‚ùå'}`);
        console.log(`Nuevo detalle: ${resultados.nuevoDetalle ? '‚úÖ' : '‚ùå'}`);
        console.log(`Inputs finales: ${resultados.inputsFinales ? '‚úÖ' : '‚ùå'}`);
        console.log(`Simulaci√≥n env√≠o: ${resultados.simulacionEnvio ? '‚úÖ' : '‚ùå'}`);
        
        const exito = Object.values(resultados).every(resultado => resultado);
        
        if (exito) {
            console.log('\nüéâ ¬°TODAS LAS PRUEBAS PASARON EXITOSAMENTE!');
            console.log('‚úÖ El sistema de comisiones Car Wash est√° funcionando correctamente');
        } else {
            console.log('\n‚ö†Ô∏è ALGUNAS PRUEBAS FALLARON');
            console.log('‚ùå Revisar los elementos que no funcionaron correctamente');
        }
        
        return exito;
        
    } catch (error) {
        console.error('üí• Error durante la prueba:', error);
        return false;
    }
}

// Auto-ejecutar la prueba cuando la p√°gina est√© lista
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ P√°gina cargada, esperando 3 segundos antes de iniciar prueba autom√°tica...');
    setTimeout(ejecutarPruebaCompleta, 3000);
});

// Exportar para uso manual
window.pruebaAutomatizada = {
    ejecutarPruebaCompleta,
    probarEdicionTrabajadores,
    probarNuevoDetalle,
    validarInputsFinales,
    simularEnvio
};

console.log('üîß Script de prueba automatizada cargado. Use window.pruebaAutomatizada para ejecutar pruebas manuales.');
